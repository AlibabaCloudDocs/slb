# 网络流量路径说明

传统型负载均衡CLB作为流量转发服务，将来自客户端的请求通过CLB集群转发至后端服务器，后端服务器再将响应通过内网返回给CLB。

## 入网流量路径

对于入网流量，CLB会根据用户在控制台或API上配置的转发策略，对来自前端的访问请求进行转发和处理，数据流转如下图所示。

![](../images/p2333.png "入网流量路径")

1.  TCP/UDP协议和HTTP/HTTPS协议的流量都需要经过LVS集群进行转发。
2.  LVS集群内的每一台节点服务器均匀地分配海量访问请求，并且每一台节点服务器之间都有会话同步策略，以保证高可用。
    -   如果相应的CLB实例服务端口使用的是四层协议（TCP或UDP），那么LVS集群内每个节点都会根据CLB实例的策略，将其承载的服务请求按策略直接分发到后端ECS服务器。
    -   如果相应的CLB实例服务端口使用的是七层HTTP协议，那么LVS集群内每个节点会先将其承载的服务请求均分到Tengine集群，Tengine集群内的每个节点再根据CLB策略，将服务请求按策略最终分发到后端ECS服务器。
    -   如果相应的CLB实例服务端口使用的是七层HTTPS协议，与上述HTTP处理过程类似，差别是在按策略将服务请求最终分发到后端ECS服务器前，先调用Key Server进行证书验证及数据包加解密等前置操作。

## 出网流量路径

CLB和后端ECS之间是通过内网进行通信的。

-   如果ECS仅仅处理来自CLB的请求，可以不购买公网带宽（ECS、公网IP、弹性公网IP、NAT网关等）。

    **说明：** 早期创建的一些ECS上直接分配了公网IP（在实例中执行`ipconfig`命令可以查看公网IP地址），此类ECS如果仅通过CLB对外提供服务，即便在公网接口（网卡）上看到有流量统计，也不会产生ECS的公网费用。

-   如果需要直接通过后端ECS对外提供服务，或后端ECS有访问外网的需求，那么需要相应的配置或购买ECS、公网IP、弹性公网IP、NAT网关等服务。

ECS的公网流量访问路径如下图所示。

![](../images/p2335.png "出网流量路径")

总体原则：流量从哪里进来，就从哪里出去。

-   通过CLB进入的流量在CLB上限速或计费，仅收取出方向流量费用，入方向流量不收取（在未来可能会改变），CLB到ECS之间是阿里云内网通信，不收取流量费用。
-   来自弹性公网IP或NAT网关的流量，分别在弹性公网IP或NAT网关上进行限速或计费。如果在购买ECS时选择了公网带宽，限速/计费点在ECS上。
-   CLB仅提供被动访问公网的能力，即后端ECS只能在收到通过CLB转发来的公网的请求时，才能访问公网回应该请求，如后端ECS希望主动发起公网访问，则需要配置或购买ECS公网带宽、弹性公网IP或NAT网关来实现。
-   ECS公网带宽（购买ECS时配置）、弹性公网IP、NAT网关均可以实现ECS的双向公网访问（访问或被访问），但没有流量分发和负载均衡的能力。

