# 添加UDP监听 {#concept_dy4_2pn_42b .concept}

UDP协议多用于关注实时性而相对不注重可靠性的场景，如视频聊天、金融实时行情推送等。您可以添加一个UDP监听转发来自UDP协议的请求。

## UDP监听限制 {#section_rln_3pn_42b .section}

在添加UDP监听前，注意如下限制：

-   UDP监听的250、4789和4790三个端口为系统保留端口，暂时不对外开放。
-   暂不支持分片包。
-   经典网络负载均衡实例的UDP监听暂不支持查看源地址。
-   在以下两种情况下，UDP协议监听配置需要五分钟才能生效：
    -   移除后端服务器。
    -   健康检查检测到异常后，将后端服务器的权重设置为0。
-   由于IPv6的IP头部较IPv4更长，当您在SLB IPv6实例上使用UDP监听时，需要确保后端服务器（通常是ECS云服务器）与SLB通信的网卡的MTU不大于1480（有些应用程序需要根据此MTU值同步修改其配置文件），否则数据包可能会因过大被丢弃。

    如果使用TCP/HTTP/HTTPS监听，TCP协议支持MSS自动协商，因此不需要额外配置。


## 前提条件 {#section_tx3_vqn_42b .section}

[创建负载均衡实例](intl.zh-CN/用户指南/负载均衡实例/创建负载均衡实例.md#)。

## 步骤一 打开监听配置向导 {#section_wx3_5qn_42b .section}

完成以下操作，打开监听配置向导：

1.  登录[负载均衡管理控制台](https://slb.console.aliyun.com)。
2.  在左侧导航栏，选择**实例** \> **实例管理**。
3.  选择实例的地域。
4.  选择以下一种方法，打开监听配置向导：
    -   在实例管理页面，找到目标实例，单击**监听配置向导**。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16139/156017989710004_zh-CN.png)

    -   在实例管理页面，单击目标实例ID。在监听页面，单击**添加监听**。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16161/15601798977399_zh-CN.png)


## 步骤二 配置协议监听 {#section_ly4_2pn_42b .section}

完成以下操作， 配置协议监听：

1.  在协议&监听页面，根据以下信息配置UDP监听。

    |监听配置|说明|
    |:---|:-|
    |**监听协议**|选择监听的协议类型。 本操作，选择**UDP**。

 |
    |**监听端口**|用来接收请求并向后端服务器进行请求转发的监听端口。 端口范围为1-65535。

 **说明：** 现在是公测阶段，您需要在[配额管理](https://slb.console.aliyun.com/slb/quota)申请**TCP/UDP协议监听同端口公测权限**，在同一个负载均衡实例内，才能在以下地域支持UDP和TCP监听端口重复。其他情况下，监听端口不可重复。

    -   澳大利亚（悉尼）
    -   阿联酋（迪拜）
    -   英国（伦敦）
    -   德国（法兰克福）
    -   美国（硅谷）
    -   美国（弗吉尼亚）
    -   印度尼西亚（雅加达）
    -   日本（东京）
    -   印度（孟买）
    -   新加坡
 |
    |**高级配置**|
    |**调度算法**|负载均衡支持轮询、加权轮询（WRR）、加权最小连接数（WLC）和一致性哈希（CH）四种调度算法。     -   **加权轮询**：权重值越高的后端服务器，被轮询到的次数（概率）也越高。
    -   **轮询**：按照访问顺序依次将外部请求依序分发到后端服务器。
    -   **加权最小连接数**：除了根据每台后端服务器设定的权重值来进行轮询，同时还考虑后端服务器的实际负载（即连接数）。当权重值相同时，当前连接数越小的后端服务器被轮询到的次数（概率）也越高。
    -   **一致性哈希（CH）**：

        -   **源IP**：基于源IP地址的一致性hash，相同的源地址会调度到相同的后端服务器。
        -   **四元组**：基于四元组的一致性hash（源IP+目的IP+源端口+目的端口），相同的流会调度到相同的后端服务器。
        -   **QUIC ID**：基于QUIC Connection ID一致性hash，相同的QUIC Connection ID会调度到相同的后端服务器。

**说明：** QUIC协议正在快速演进，该算法基于[draft-ietf-quic-transport-10](https://datatracker.ietf.org/doc/draft-ietf-quic-transport/10/)实现，无法保证所有QUIC版本的兼容性，建议充分测试后再用于生产环境。

**说明：** 

一致性哈希（CH）算法目前仅支持以下地域：

        -   日本（东京）
        -   澳大利亚（悉尼）
        -   马来西亚（吉隆坡）
        -   印度尼西亚（雅加达）
        -   德国（法兰克福）
        -   美国（硅谷）
        -   美国（弗吉利亚）
        -   阿联酋（迪拜）
        -   华北5（呼和浩特）
 |
    |**启用访问控制**|选择是否启用访问控制。|
    |**访问控制方式**| 开启访问控制后，选择一种访问控制方式：

     -   **白名单**：仅转发来自所选访问控制策略组中设置的IP地址或地址段的请求，白名单适用于应用只允许特定IP访问的场景。

设置白名单存在一定业务风险。一旦设置白名单，就只有白名单中的IP可以访问负载均衡监听。如果开启了白名单访问，但访问策略组中没有添加任何IP，则负载均衡监听会转发全部请求。

    -   **黑名单**：来自所选访问控制策略组中设置的IP地址或地址段的所有请求都不会转发，黑名单适用于应用只限制某些特定IP访问的场景。

如果开启了黑名单访问，但访问策略组中没有添加任何IP，则负载均衡监听会转发全部请求。

 |
    |**选择访问控制策略组**|选择访问控制策略组，作为该监听的白名单或黑名单。 **说明：** IPv6实例只能绑定IPv6访问控制策略组，IPv4实例只能绑定IPv4访问控制策略组。详情参见[访问控制策略组](intl.zh-CN/历史文档/用户指南（旧版控制台）/访问控制/配置访问控制策略组.md#)。

 |
    |**开启带宽峰值**| 选择是否配置监听带宽。

 对于按带宽计费的负载均衡实例，您可以针对不同监听设定不同的带宽峰值来限定监听的流量。实例下所有监听的带宽峰值总和不能超过该实例的带宽。

 默认不开启，各监听共享实例的总带宽。

 **说明：** 使用流量计费方式的实例默认不限制带宽峰值。

 |
    |**获取真实IP**|UDP协议监听的后端服务器可直接获取客户端的真实IP。 **说明：** 经典网络实例的UDP协议暂不支持查看源地址。

 |
    |**创建完毕自动启动监听**|是否在监听配置完成后启动负载均衡监听，默认开启。|

2.  单击**下一步**。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16161/15601798987426_zh-CN.png)


## 步骤三 添加后端服务器 {#section_ylm_3qn_42b .section}

添加处理前端请求的后端服务器。您可以使用实例配置的默认服务器组，也可以为监听配置一个虚拟服务器组或主备服务器组。详情参见[后端服务器概述](intl.zh-CN/用户指南/后端服务器/后端服务器概述.md#)。

本操作中，以默认后端服务器组为例：

1.  选择**默认服务器组**，单击**继续添加**。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16139/156017989810030_zh-CN.png)

2.  选择要添加的ECS实例，然后单击**下一步：配置权重和端口号**。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16139/15601798987499_zh-CN.png)

3.  配置添加的后端服务器的端口和权重。
    -   端口

        后端服务器（ECS实例）开放用来接收请求的端口，端口范围为1-65535。同一个负载均衡实例内，后端服务器端口可以相同。

    -   权重

        后端服务器（ECS实例）的权重。权重越高的ECS实例将被分配到更多的访问请求。

        **说明：** 权重设置为0，该服务器不会再接受新请求。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16139/15601798997504_zh-CN.png)

4.  单击**下一步**。

## 步骤四 配置健康检查 {#section_ay4_jqn_42b .section}

负载均衡通过健康检查来判断后端服务器（ECS实例）的业务可用性。健康检查机制提高了前端业务整体可用性，避免了后端ECS异常对总体服务的影响。单击**修改**更改健康检查配置，详情参见[配置健康检查](intl.zh-CN/用户指南/健康检查/配置健康检查.md#)。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16139/156017989910032_zh-CN.png)

## 步骤五 提交配置 {#section_ey5_lqn_42b .section}

完成以下操作，确认监听配置：

1.  在配置审核页面，检查监听配置，您可以单击**修改**更改配置。
2.  确认无误后，单击**提交**。
3.  在配置审核页面，配置成功后，单击**确定**。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16139/156017989910033_zh-CN.png)


配置成功后，您可以在监听页面查看已创建的监听。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16139/156017990010034_zh-CN.png)

## 相关操作 {#section_pz4_2pn_42b .section}

-   [配置健康检查](intl.zh-CN/用户指南/健康检查/配置健康检查.md#)
-   [管理默认服务器组](intl.zh-CN/用户指南/后端服务器/管理默认服务器组.md#)
-   [管理虚拟服务器组](intl.zh-CN/用户指南/后端服务器/管理虚拟服务器组.md#)
-   [管理主备服务器组](intl.zh-CN/用户指南/后端服务器/管理主备服务器组.md#)
-   [设置访问控制](intl.zh-CN/用户指南/访问控制/设置访问控制.md#)

